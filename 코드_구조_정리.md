# SmoothTalkAI Backend ì½”ë“œ êµ¬ì¡° ì •ë¦¬

## ğŸ“‹ ëª©ì°¨
1. [ì „ì²´ ê°œìš”](#ì „ì²´-ê°œìš”)
2. [í”„ë¡œì íŠ¸ êµ¬ì¡°](#í”„ë¡œì íŠ¸-êµ¬ì¡°)
3. [ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •](#ì• í”Œë¦¬ì¼€ì´ì…˜-ì„¤ì •)
4. [íŒ¨í‚¤ì§€ë³„ ìƒì„¸ ì„¤ëª…](#íŒ¨í‚¤ì§€ë³„-ìƒì„¸-ì„¤ëª…)
5. [API ì—”ë“œí¬ì¸íŠ¸ ì •ë¦¬](#api-ì—”ë“œí¬ì¸íŠ¸-ì •ë¦¬)
6. [ì¸ì¦ & ì¸ê°€ íë¦„](#ì¸ì¦--ì¸ê°€-íë¦„)
7. [ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°](#ë°ì´í„°ë² ì´ìŠ¤-êµ¬ì¡°)
8.test kkã…œã…œ
---

## ì „ì²´ ê°œìš”

ì´ í”„ë¡œì íŠ¸ëŠ” **Spring Boot ê¸°ë°˜ì˜ ëŒ€í™”(Conversation) ê´€ë¦¬ ë° ë¶„ì„ ë°±ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜**ì…ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥
- ğŸ” Google OAuth2ë¥¼ í†µí•œ ì‚¬ìš©ì ì¸ì¦
- ğŸ”‘ JWT ê¸°ë°˜ ì¸ê°€ ì²˜ë¦¬
- ğŸ’¬ ëŒ€í™”(Conversation) ë° ë©”ì‹œì§€(Message) CRUD
- ğŸ“Š ëŒ€í™” ë‚´ìš© ë¶„ì„ (ìš”ì•½, ì¡°ì–¸, ìƒ˜í”Œ ë‹µë³€ ìƒì„±)
- ğŸ‘¤ ì‚¬ìš©ì í”„ë¡œí•„ ê´€ë¦¬

### ê¸°ìˆ  ìŠ¤íƒ
- **Framework**: Spring Boot
- **Database**: PostgreSQL
- **ORM**: JPA/Hibernate
- **Security**: Spring Security + JWT + OAuth2
- **Build**: Gradle

---

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
src/main/java/com/smoothTalkAI/backend/
â”œâ”€â”€ SmoothTalkAiBackendApplication.java    # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë˜ìŠ¤
â”œâ”€â”€ analysis/                              # ëŒ€í™” ë¶„ì„ ì„œë¹„ìŠ¤
â”‚   â””â”€â”€ AnalysisService.java
â”œâ”€â”€ common/                                # ê³µí†µ ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ BaseTimeEntity.java               # ì‹œê°„ í•„ë“œ ê³µí†µ ì—”í‹°í‹°
â”‚   â””â”€â”€ JsonListConverter.java            # JSON ì»¬ëŸ¼ ë³€í™˜ê¸°
â”œâ”€â”€ config/                                # ì„¤ì • í´ë˜ìŠ¤
â”‚   â”œâ”€â”€ SecurityConfig.java               # Spring Security ì„¤ì •
â”‚   â””â”€â”€ RestAuthenticationEntryPoint.java # ì¸ì¦ ì‹¤íŒ¨ í•¸ë“¤ëŸ¬
â”œâ”€â”€ controller/                            # REST API ì»¨íŠ¸ë¡¤ëŸ¬
â”‚   â”œâ”€â”€ AnalysisController.java
â”‚   â”œâ”€â”€ AuthController.java
â”‚   â”œâ”€â”€ ConversationController.java
â”‚   â””â”€â”€ MessageController.java
â”œâ”€â”€ conversation/                          # ëŒ€í™” ë„ë©”ì¸
â”‚   â”œâ”€â”€ Conversation.java                 # ì—”í‹°í‹°
â”‚   â”œâ”€â”€ ConversationRepository.java       # ë¦¬í¬ì§€í† ë¦¬
â”‚   â””â”€â”€ ConversationService.java          # ì„œë¹„ìŠ¤
â”œâ”€â”€ dto/                                   # ë°ì´í„° ì „ì†¡ ê°ì²´
â”‚   â”œâ”€â”€ ApiResponse.java
â”‚   â”œâ”€â”€ ApiErrorResponse.java
â”‚   â”œâ”€â”€ AuthUserResponse.java
â”‚   â”œâ”€â”€ JwtLoginResponse.java
â”‚   â”œâ”€â”€ ConversationCreateRequest.java
â”‚   â”œâ”€â”€ ConversationSummaryResponse.java
â”‚   â”œâ”€â”€ ConversationDetailResponse.java
â”‚   â”œâ”€â”€ ConversationAnalysisDto.java
â”‚   â”œâ”€â”€ MessageRequest.java
â”‚   â”œâ”€â”€ MessageResponse.java
â”‚   â”œâ”€â”€ AnalysisRequest.java
â”‚   â”œâ”€â”€ AnalysisResponse.java
â”‚   â””â”€â”€ AnalysisMessageDto.java
â”œâ”€â”€ exception/                             # ì˜ˆì™¸ ì²˜ë¦¬
â”‚   â”œâ”€â”€ ApiException.java                 # ì»¤ìŠ¤í…€ ì˜ˆì™¸
â”‚   â””â”€â”€ GlobalExceptionHandler.java       # ì „ì—­ ì˜ˆì™¸ í•¸ë“¤ëŸ¬
â”œâ”€â”€ message/                               # ë©”ì‹œì§€ ë„ë©”ì¸
â”‚   â”œâ”€â”€ Message.java                      # ì—”í‹°í‹°
â”‚   â”œâ”€â”€ MessageRepository.java            # ë¦¬í¬ì§€í† ë¦¬
â”‚   â”œâ”€â”€ MessageService.java               # ì„œë¹„ìŠ¤
â”‚   â””â”€â”€ SenderType.java                   # ë°œì‹ ì íƒ€ì… enum
â”œâ”€â”€ security/                              # ë³´ì•ˆ ê´€ë ¨
â”‚   â”œâ”€â”€ JwtProvider.java                  # JWT ìƒì„±/ê²€ì¦
â”‚   â”œâ”€â”€ JwtProperties.java                # JWT ì„¤ì •
â”‚   â”œâ”€â”€ JwtAuthenticationFilter.java      # JWT ì¸ì¦ í•„í„°
â”‚   â”œâ”€â”€ JwtAccessDeniedHandler.java       # ì¸ê°€ ì‹¤íŒ¨ í•¸ë“¤ëŸ¬
â”‚   â”œâ”€â”€ OAuth2SuccessHandler.java         # OAuth2 ì„±ê³µ í•¸ë“¤ëŸ¬
â”‚   â””â”€â”€ UserPrincipal.java                # Spring Security ì‚¬ìš©ì ì •ë³´
â””â”€â”€ user/                                  # ì‚¬ìš©ì ë„ë©”ì¸
    â”œâ”€â”€ User.java                         # ì—”í‹°í‹°
    â”œâ”€â”€ UserRepository.java               # ë¦¬í¬ì§€í† ë¦¬
    â”œâ”€â”€ UserService.java                  # ì„œë¹„ìŠ¤
    â””â”€â”€ PlanType.java                     # ìš”ê¸ˆì œ íƒ€ì… enum
```

---

## ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •

### application.yml

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/smoothtalkai
    username: smoothtalkai
    password: smoothtalkai123!
    driver-class-name: org.postgresql.Driver
  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        format_sql: true
        jdbc:
          time_zone: UTC
    open-in-view: false
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${OAUTH_GOOGLE_CLIENT_ID}
            client-secret: ${OAUTH_GOOGLE_CLIENT_SECRET}
            redirect-uri: "{baseUrl}/login/oauth2/code/google"
            scope:
              - openid
              - profile
              - email
        provider:
          google:
            issuer-uri: https://accounts.google.com

logging:
  level:
    org.springframework.security: INFO
    com.smoothTalkAI.backend: DEBUG

jwt:
  secret: ${JWT_SECRET:this_is_a_dev_jwt_secret_key_that_is_long_enough_123456}
  access-token-validity-in-sec: 3600

app:
  oauth2:
    success-redirect: https://localhost:3000/oauth2/callback
```

**ì£¼ìš” ì„¤ì • ì„¤ëª…:**
- **ì„œë²„ í¬íŠ¸**: 8080
- **ë°ì´í„°ë² ì´ìŠ¤**: PostgreSQL (localhost:5432)
- **JPA**: `ddl-auto: update` (ìŠ¤í‚¤ë§ˆ ìë™ ì—…ë°ì´íŠ¸)
- **OAuth2**: Google ë¡œê·¸ì¸ ì„¤ì • (í™˜ê²½ë³€ìˆ˜ë¡œ í´ë¼ì´ì–¸íŠ¸ ID/Secret ê´€ë¦¬)
- **JWT**: ì‹œí¬ë¦¿ í‚¤ì™€ í† í° ìœ íš¨ê¸°ê°„(3600ì´ˆ = 1ì‹œê°„) ì„¤ì •
- **CORS**: SecurityConfigì—ì„œ localhost:3000 í—ˆìš©

---

## íŒ¨í‚¤ì§€ë³„ ìƒì„¸ ì„¤ëª…

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì 

#### SmoothTalkAiBackendApplication.java

```java
@SpringBootApplication
public class SmoothTalkAiBackendApplication {
    public static void main(String[] args) {
        SpringApplication.run(SmoothTalkAiBackendApplication.class, args);
    }
}
```

- **ì—­í• **: Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë©”ì¸ í´ë˜ìŠ¤
- **ì„¤ëª…**: `@SpringBootApplication` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ ìë™ ì„¤ì • ë° ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº” í™œì„±í™”

---

### 2. common íŒ¨í‚¤ì§€ (ê³µí†µ ìœ í‹¸ë¦¬í‹°)

#### BaseTimeEntity.java

```java
@Getter
@MappedSuperclass
public abstract class BaseTimeEntity {
    @Column(name = "created_at", nullable = false, updatable = false)
    private OffsetDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private OffsetDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        OffsetDateTime now = OffsetDateTime.now(ZoneOffset.UTC);
        this.createdAt = now;
        this.updatedAt = now;
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = OffsetDateTime.now(ZoneOffset.UTC);
    }

    protected void touch() {
        this.updatedAt = OffsetDateTime.now(ZoneOffset.UTC);
    }
}
```

- **ì—­í• **: ìƒì„±/ìˆ˜ì • ì‹œê°„ì„ ìë™ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê³µí†µ ì—”í‹°í‹°
- **ì‚¬ìš©ì²˜**: `User`, `Conversation` ì—”í‹°í‹°ê°€ ìƒì†
- **ê¸°ëŠ¥**:
  - `@PrePersist`: ì—”í‹°í‹° ì €ì¥ ì‹œ `createdAt`, `updatedAt` ìë™ ì„¤ì •
  - `@PreUpdate`: ì—”í‹°í‹° ì—…ë°ì´íŠ¸ ì‹œ `updatedAt` ìë™ ê°±ì‹ 
  - `touch()`: ìˆ˜ë™ìœ¼ë¡œ `updatedAt` ê°±ì‹  ê°€ëŠ¥

#### JsonListConverter.java

```java
@Converter
public class JsonListConverter implements AttributeConverter<List<String>, String> {
    private static final ObjectMapper MAPPER = new ObjectMapper();

    @Override
    public String convertToDatabaseColumn(List<String> attribute) {
        if (attribute == null) return null;
        try {
            return MAPPER.writeValueAsString(attribute);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON ì§ë ¬í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", e);
        }
    }

    @Override
    public List<String> convertToEntityAttribute(String dbData) {
        if (dbData == null) return Collections.emptyList();
        try {
            return MAPPER.readValue(dbData, 
                MAPPER.getTypeFactory().constructCollectionType(List.class, String.class));
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON ì—­ì§ë ¬í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", e);
        }
    }
}
```

- **ì—­í• **: `List<String>`ì„ DBì˜ JSON ë¬¸ìì—´ë¡œ ì €ì¥/ì¡°íšŒí•˜ëŠ” ë³€í™˜ê¸°
- **ì‚¬ìš©ì²˜**: `Conversation.analysisAdvice`, `Conversation.analysisSampleReplies`
- **ê¸°ëŠ¥**: JPA AttributeConverter ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„

---

### 3. config íŒ¨í‚¤ì§€ (ì„¤ì •)

#### SecurityConfig.java

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@EnableConfigurationProperties(JwtProperties.class)
@RequiredArgsConstructor
public class SecurityConfig {
    private final JwtAuthenticationFilter jwtAuthenticationFilter;
    private final OAuth2SuccessHandler oAuth2SuccessHandler;
    private final RestAuthenticationEntryPoint restAuthenticationEntryPoint;
    private final JwtAccessDeniedHandler jwtAccessDeniedHandler;

    @Bean
    SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .cors(Customizer.withDefaults())
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/auth/google/**", "/oauth2/**", "/login/**", "/error")
                    .permitAll()
                .requestMatchers(HttpMethod.GET, "/actuator/health").permitAll()
                .anyRequest().authenticated())
            .oauth2Login(oauth -> oauth.successHandler(oAuth2SuccessHandler))
            .exceptionHandling(ex -> ex
                .authenticationEntryPoint(restAuthenticationEntryPoint)
                .accessDeniedHandler(jwtAccessDeniedHandler))
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
        return http.build();
    }

    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(List.of("http://localhost:3000"));
        configuration.setAllowedMethods(List.of("GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"));
        configuration.setAllowedHeaders(List.of("*"));
        configuration.setAllowCredentials(true);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

- **ì—­í• **: Spring Security ì„¤ì •
- **ì£¼ìš” ì„¤ì •**:
  - **CSRF ë¹„í™œì„±í™”**: JWT ê¸°ë°˜ ì¸ì¦ ì‚¬ìš©
  - **ì„¸ì…˜ ì •ì±…**: STATELESS (ì„¸ì…˜ ì—†ìŒ)
  - **ê³µê°œ ì—”ë“œí¬ì¸íŠ¸**: `/auth/google/**`, `/oauth2/**`, `/login/**`, `/error`, `GET /actuator/health`
  - **ì¸ì¦ í•„ìš”**: ìœ„ ì—”ë“œí¬ì¸íŠ¸ ì™¸ ëª¨ë“  ìš”ì²­
  - **OAuth2**: Google ë¡œê·¸ì¸ ì„±ê³µ ì‹œ `OAuth2SuccessHandler` ì‚¬ìš©
  - **ì˜ˆì™¸ ì²˜ë¦¬**: 
    - ì¸ì¦ ì‹¤íŒ¨ â†’ `RestAuthenticationEntryPoint`
    - ì¸ê°€ ì‹¤íŒ¨ â†’ `JwtAccessDeniedHandler`
  - **JWT í•„í„°**: `JwtAuthenticationFilter`ë¥¼ `UsernamePasswordAuthenticationFilter` ì•ì— ì¶”ê°€
  - **CORS**: `http://localhost:3000` í—ˆìš©

#### RestAuthenticationEntryPoint.java

```java
@Slf4j
@Component
public class RestAuthenticationEntryPoint implements AuthenticationEntryPoint {
    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response,
                        AuthenticationException authException) throws IOException {
        log.warn("Unauthorized request: {}", authException.getMessage());
        response.setStatus(HttpStatus.UNAUTHORIZED.value());
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        response.getWriter().write(ApiErrorResponse.unauthorized().toJson());
    }
}
```

- **ì—­í• **: ì¸ì¦ ì‹¤íŒ¨ ì‹œ (401 Unauthorized) ì‘ë‹µ ì²˜ë¦¬
- **ì‘ë‹µ**: JSON í˜•ì‹ì˜ `ApiErrorResponse`

---

### 4. security íŒ¨í‚¤ì§€ (ë³´ì•ˆ)

#### JwtProperties.java

```java
@Getter
@Setter
@ConfigurationProperties(prefix = "jwt")
public class JwtProperties {
    private String secret;
    private long accessTokenValidityInSec;
}
```

- **ì—­í• **: `application.yml`ì˜ `jwt.*` ì„¤ì • ê°’ì„ ë°”ì¸ë”©
- **ì„¤ì •ê°’**:
  - `secret`: JWT ì„œëª…ì— ì‚¬ìš©í•  ì‹œí¬ë¦¿ í‚¤
  - `accessTokenValidityInSec`: Access Token ìœ íš¨ ì‹œê°„ (ì´ˆ)

#### JwtProvider.java

```java
@Component
@RequiredArgsConstructor
public class JwtProvider {
    private final JwtProperties properties;
    private SecretKey secretKey;

    @PostConstruct
    void init() {
        this.secretKey = Keys.hmacShaKeyFor(
            properties.getSecret().getBytes(StandardCharsets.UTF_8));
    }

    public String generateAccessToken(User user) {
        Date now = new Date();
        Date expiry = Date.from(Instant.ofEpochMilli(now.getTime())
            .plusSeconds(properties.getAccessTokenValidityInSec()));

        return Jwts.builder()
            .setSubject(String.valueOf(user.getId()))
            .claim("email", user.getEmail())
            .claim("name", user.getName())
            .setIssuedAt(now)
            .setExpiration(expiry)
            .signWith(secretKey, SignatureAlgorithm.HS256)
            .compact();
    }

    public boolean validate(String token) {
        try {
            Jwts.parserBuilder().setSigningKey(secretKey).build().parseClaimsJws(token);
            return true;
        } catch (Exception ex) {
            return false;
        }
    }

    public Long extractUserId(String token) {
        Claims claims = Jwts.parserBuilder().setSigningKey(secretKey).build()
            .parseClaimsJws(token).getBody();
        return Long.parseLong(claims.getSubject());
    }
}
```

- **ì—­í• **: JWT í† í° ìƒì„±, ê²€ì¦, ì‚¬ìš©ì ID ì¶”ì¶œ
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `generateAccessToken(User)`: ì‚¬ìš©ì ì •ë³´ë¥¼ ë‹´ì€ JWT í† í° ìƒì„± (HS256 ì•Œê³ ë¦¬ì¦˜)
  - `validate(String)`: í† í° ìœ íš¨ì„± ê²€ì¦
  - `extractUserId(String)`: í† í°ì—ì„œ ì‚¬ìš©ì ID ì¶”ì¶œ

#### JwtAuthenticationFilter.java

```java
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    private static final String BEARER_PREFIX = "Bearer ";
    private final JwtProvider jwtProvider;
    private final UserService userService;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                   HttpServletResponse response,
                                   FilterChain filterChain) 
        throws ServletException, IOException {
        String token = resolveToken(request);
        if (StringUtils.hasText(token) && jwtProvider.validate(token)) {
            Long userId = jwtProvider.extractUserId(token);
            UserPrincipal principal = userService.loadUserPrincipal(userId);

            UsernamePasswordAuthenticationToken authentication =
                new UsernamePasswordAuthenticationToken(
                    principal, null, principal.getAuthorities());
            authentication.setDetails(
                new WebAuthenticationDetailsSource().buildDetails(request));
            SecurityContextHolder.getContext().setAuthentication(authentication);
        }
        filterChain.doFilter(request, response);
    }

    private String resolveToken(HttpServletRequest request) {
        String header = request.getHeader("Authorization");
        if (!StringUtils.hasText(header) || !header.startsWith(BEARER_PREFIX)) {
            return null;
        }
        return header.substring(BEARER_PREFIX.length());
    }
}
```

- **ì—­í• **: ìš”ì²­ë§ˆë‹¤ `Authorization` í—¤ë”ì—ì„œ JWT ì¶”ì¶œ í›„ ì¸ì¦ ì²˜ë¦¬
- **ë™ì‘ íë¦„**:
  1. `Authorization: Bearer {token}` í—¤ë”ì—ì„œ í† í° ì¶”ì¶œ
  2. í† í° ìœ íš¨ì„± ê²€ì¦
  3. í† í°ì—ì„œ ì‚¬ìš©ì ID ì¶”ì¶œ
  4. `UserService`ë¡œ `UserPrincipal` ë¡œë“œ
  5. `SecurityContextHolder`ì— ì¸ì¦ ì •ë³´ ì„¤ì •

#### UserPrincipal.java

```java
@Getter
@Builder
public class UserPrincipal implements UserDetails {
    private final Long id;
    private final String email;
    private final String name;
    private final String profileImage;
    private final Collection<? extends GrantedAuthority> authorities;

    public static UserPrincipal from(User user) {
        return UserPrincipal.builder()
            .id(user.getId())
            .email(user.getEmail())
            .name(user.getName())
            .profileImage(user.getProfileImage())
            .authorities(List.of(new SimpleGrantedAuthority("ROLE_USER")))
            .build();
    }

    @Override
    public String getPassword() { return null; }

    @Override
    public String getUsername() { return email; }

    @Override
    public boolean isAccountNonExpired() { return true; }

    @Override
    public boolean isAccountNonLocked() { return true; }

    @Override
    public boolean isCredentialsNonExpired() { return true; }

    @Override
    public boolean isEnabled() { return true; }
}
```

- **ì—­í• **: Spring Securityì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ (`UserDetails` êµ¬í˜„)
- **ê¸°ëŠ¥**: `User` ì—”í‹°í‹°ë¥¼ `UserPrincipal`ë¡œ ë³€í™˜í•˜ì—¬ Spring Security ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥

#### OAuth2SuccessHandler.java

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class OAuth2SuccessHandler implements AuthenticationSuccessHandler {
    private final UserService userService;
    private final JwtProvider jwtProvider;
    private final JwtProperties jwtProperties;
    private final ObjectMapper objectMapper;

    @Value("${app.oauth2.success-redirect:}")
    private String successRedirect;

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request,
                                       HttpServletResponse response,
                                       Authentication authentication) 
        throws IOException {
        OAuth2AuthenticationToken oauthToken = (OAuth2AuthenticationToken) authentication;
        var attributes = oauthToken.getPrincipal().getAttributes();

        String providerUserId = (String) attributes.get("sub");
        String email = (String) attributes.get("email");
        String name = (String) attributes.get("name");
        String picture = (String) attributes.get("picture");

        User user = userService.upsertGoogleUser(providerUserId, email, name, picture);
        userService.updateLastLogin(user.getId());

        String jwt = jwtProvider.generateAccessToken(user);
        JwtLoginResponse payload = JwtLoginResponse.builder()
            .token(jwt)
            .expiresIn(jwtProperties.getAccessTokenValidityInSec())
            .issuedAt(Instant.now())
            .user(AuthUserResponse.from(user))
            .build();

        if (StringUtils.hasText(successRedirect)) {
            String target = UriComponentsBuilder.fromUriString(successRedirect)
                .queryParam("token", jwt)
                .build().toUriString();
            response.sendRedirect(target);
            return;
        }

        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        objectMapper.writeValue(response.getWriter(), payload);
    }
}
```

- **ì—­í• **: Google OAuth2 ë¡œê·¸ì¸ ì„±ê³µ í›„ ì²˜ë¦¬
- **ë™ì‘ íë¦„**:
  1. Googleì—ì„œ ë°›ì€ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ (`sub`, `email`, `name`, `picture`)
  2. `UserService.upsertGoogleUser()`ë¡œ DBì— ì‚¬ìš©ì ì €ì¥/ì—…ë°ì´íŠ¸
  3. ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸
  4. JWT í† í° ìƒì„±
  5. `app.oauth2.success-redirect` ì„¤ì •ì´ ìˆìœ¼ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸, ì—†ìœ¼ë©´ JSON ì‘ë‹µ

#### JwtAccessDeniedHandler.java

```java
@Slf4j
@Component
public class JwtAccessDeniedHandler implements AccessDeniedHandler {
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response,
                      AccessDeniedException accessDeniedException) throws IOException {
        log.warn("Access denied: {}", accessDeniedException.getMessage());
        response.setStatus(HttpStatus.FORBIDDEN.value());
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        response.getWriter().write(ApiErrorResponse.forbidden().toJson());
    }
}
```

- **ì—­í• **: ì¸ê°€ ì‹¤íŒ¨ ì‹œ (403 Forbidden) ì‘ë‹µ ì²˜ë¦¬

---

### 5. user íŒ¨í‚¤ì§€ (ì‚¬ìš©ì ë„ë©”ì¸)

#### User.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "users")
public class User extends BaseTimeEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "provider", nullable = false, length = 20)
    private String provider;  // "google"

    @Column(name = "provider_user_id", nullable = false, length = 255)
    private String providerUserId;  // Googleì˜ sub ê°’

    @Column(name = "email", nullable = false, length = 255, unique = true)
    private String email;

    @Column(name = "name", length = 100)
    private String name;

    @Column(name = "profile_image")
    private String profileImage;

    @Enumerated(EnumType.STRING)
    @Column(name = "plan", length = 20)
    @Builder.Default
    private PlanType plan = PlanType.FREE;

    @Column(name = "last_login_at")
    private OffsetDateTime lastLoginAt;

    @OneToMany(mappedBy = "user", cascade = CascadeType.ALL, orphanRemoval = true)
    @Builder.Default
    private List<Conversation> conversations = new ArrayList<>();

    public void updateProfile(String newName, String newProfileImage) {
        this.name = newName;
        this.profileImage = newProfileImage;
    }

    public void updatePlan(PlanType newPlan) {
        this.plan = newPlan;
    }

    public void updateLastLogin() {
        this.lastLoginAt = OffsetDateTime.now(ZoneOffset.UTC);
    }
}
```

- **ì—­í• **: OAuth2ë¡œ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì—”í‹°í‹°
- **ì£¼ìš” í•„ë“œ**:
  - `provider`: OAuth ì œê³µì (ì˜ˆ: "google")
  - `providerUserId`: ì œê³µìì˜ ì‚¬ìš©ì ID (Googleì˜ `sub`)
  - `plan`: ìš”ê¸ˆì œ íƒ€ì… (ê¸°ë³¸ê°’: FREE)
  - `conversations`: ì‚¬ìš©ìê°€ ê°€ì§„ ëŒ€í™” ë¦¬ìŠ¤íŠ¸

#### PlanType.java

```java
public enum PlanType {
    FREE,
    PRO
}
```

- **ì—­í• **: ì‚¬ìš©ì ìš”ê¸ˆì œ íƒ€ì… enum

#### UserRepository.java

```java
public interface UserRepository extends JpaRepository<User, Long> {
    Optional<User> findByProviderAndProviderUserId(String provider, String providerUserId);
    Optional<User> findByEmail(String email);
}
```

- **ì—­í• **: User ì—”í‹°í‹°ì˜ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼
- **ì£¼ìš” ì¿¼ë¦¬**:
  - `findByProviderAndProviderUserId`: OAuth ì œê³µì + ì œê³µì ì‚¬ìš©ì IDë¡œ ê²€ìƒ‰
  - `findByEmail`: ì´ë©”ì¼ë¡œ ê²€ìƒ‰

#### UserService.java

```java
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class UserService implements UserDetailsService {
    private static final String GOOGLE_PROVIDER = "google";
    private final UserRepository userRepository;

    @Transactional
    public User upsertGoogleUser(String providerUserId, String email, 
                                 String name, String picture) {
        return userRepository.findByProviderAndProviderUserId(
                GOOGLE_PROVIDER, providerUserId)
            .map(user -> {
                user.updateProfile(name, picture);
                return user;
            })
            .orElseGet(() -> userRepository.save(User.builder()
                .provider(GOOGLE_PROVIDER)
                .providerUserId(providerUserId)
                .email(email)
                .name(name)
                .profileImage(picture)
                .plan(PlanType.FREE)
                .build()));
    }

    @Transactional
    public void updateLastLogin(Long userId) {
        User user = getUserOrThrow(userId);
        user.updateLastLogin();
    }

    public User getUserOrThrow(Long id) {
        return userRepository.findById(id)
            .orElseThrow(() -> ApiException.notFound("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    }

    public UserPrincipal loadUserPrincipal(Long userId) {
        return UserPrincipal.from(getUserOrThrow(userId));
    }

    @Override
    public UserDetails loadUserByUsername(String username) 
        throws UsernameNotFoundException {
        User user = userRepository.findByEmail(username)
            .orElseThrow(() -> new UsernameNotFoundException("ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        return UserPrincipal.from(user);
    }
}
```

- **ì—­í• **: ì‚¬ìš©ì ì¡°íšŒ/ì—…ë°ì´íŠ¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `upsertGoogleUser()`: Google ì‚¬ìš©ì ì •ë³´ë¡œ ì €ì¥ ë˜ëŠ” ì—…ë°ì´íŠ¸
  - `updateLastLogin()`: ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ê°±ì‹ 
  - `loadUserPrincipal()`: `User`ë¥¼ `UserPrincipal`ë¡œ ë³€í™˜ (JWT í•„í„°ì—ì„œ ì‚¬ìš©)
  - `loadUserByUsername()`: `UserDetailsService` êµ¬í˜„ (ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì¡°íšŒ)

---

### 6. conversation íŒ¨í‚¤ì§€ (ëŒ€í™” ë„ë©”ì¸)

#### Conversation.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "conversations")
public class Conversation extends BaseTimeEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "user_id")
    private User user;

    @Column(name = "title", nullable = false, length = 100)
    private String title;

    @Column(name = "analysis_summary", columnDefinition = "text")
    private String analysisSummary;

    @Convert(converter = JsonListConverter.class)
    @Column(name = "analysis_advice", columnDefinition = "jsonb")
    private List<String> analysisAdvice;

    @Convert(converter = JsonListConverter.class)
    @Column(name = "analysis_sample_replies", columnDefinition = "jsonb")
    private List<String> analysisSampleReplies;

    @OneToMany(mappedBy = "conversation", cascade = CascadeType.ALL, orphanRemoval = true)
    @OrderBy("createdAt ASC")
    @Builder.Default
    private List<Message> messages = new ArrayList<>();

    public void changeTitle(String newTitle) {
        this.title = newTitle;
        touch();
    }

    public void renameWithSnippet(String messageText) {
        if (messageText == null || messageText.isBlank()) return;
        String snippet = messageText.length() > 50 
            ? messageText.substring(0, 50) + "..." 
            : messageText;
        changeTitle(snippet);
    }

    public void applyAnalysis(String summary, List<String> advice, List<String> samples) {
        this.analysisSummary = summary;
        this.analysisAdvice = advice;
        this.analysisSampleReplies = samples;
        touch();
    }

    public void markUpdated() {
        touch();
    }
}
```

- **ì—­í• **: í•˜ë‚˜ì˜ ëŒ€í™”ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì—”í‹°í‹°
- **ì£¼ìš” í•„ë“œ**:
  - `user`: ëŒ€í™” ì†Œìœ ì (ManyToOne)
  - `title`: ëŒ€í™” ì œëª©
  - `analysisSummary`: ë¶„ì„ ìš”ì•½ í…ìŠ¤íŠ¸
  - `analysisAdvice`: ë¶„ì„ ì¡°ì–¸ ë¦¬ìŠ¤íŠ¸ (JSON ì»¬ëŸ¼)
  - `analysisSampleReplies`: ë¶„ì„ ìƒ˜í”Œ ë‹µë³€ ë¦¬ìŠ¤íŠ¸ (JSON ì»¬ëŸ¼)
  - `messages`: ëŒ€í™”ì— ì†í•œ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ (ì‹œê°„ìˆœ ì •ë ¬)
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `renameWithSnippet()`: ì²« ë©”ì‹œì§€ì˜ ì•ë¶€ë¶„ì„ ì œëª©ìœ¼ë¡œ ìë™ ì„¤ì •
  - `applyAnalysis()`: ë¶„ì„ ê²°ê³¼ ì €ì¥

#### ConversationRepository.java

```java
public interface ConversationRepository extends JpaRepository<Conversation, Long> {
    List<Conversation> findAllByUserIdOrderByUpdatedAtDesc(Long userId);
    Optional<Conversation> findByIdAndUserId(Long id, Long userId);
}
```

- **ì—­í• **: Conversation ì—”í‹°í‹°ì˜ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼
- **ì£¼ìš” ì¿¼ë¦¬**:
  - `findAllByUserIdOrderByUpdatedAtDesc`: ì‚¬ìš©ìì˜ ëŒ€í™” ëª©ë¡ (ìµœì‹ ìˆœ)
  - `findByIdAndUserId`: íŠ¹ì • ì‚¬ìš©ìì˜ ëŒ€í™” ì¡°íšŒ (ì†Œìœ ê¶Œ ê²€ì¦ìš©)

#### ConversationService.java

```java
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class ConversationService {
    private final ConversationRepository conversationRepository;
    private final MessageRepository messageRepository;
    private final UserService userService;

    public List<ConversationSummaryResponse> getConversations(Long userId) {
        return conversationRepository.findAllByUserIdOrderByUpdatedAtDesc(userId)
            .stream()
            .map(ConversationSummaryResponse::from)
            .toList();
    }

    public ConversationDetailResponse getConversation(Long userId, Long conversationId) {
        Conversation conversation = findOwnedConversation(userId, conversationId);
        List<MessageResponse> messages = messageRepository
            .findByConversationIdOrderByCreatedAtAsc(conversation.getId())
            .stream()
            .map(MessageResponse::from)
            .toList();
        return ConversationDetailResponse.of(conversation, messages);
    }

    @Transactional
    public ConversationSummaryResponse createConversation(Long userId, 
                                                          ConversationCreateRequest request) {
        var user = userService.getUserOrThrow(userId);
        String requestedTitle = request != null ? request.getTitle() : null;
        String title = StringUtils.hasText(requestedTitle) ? requestedTitle : "ìƒˆ ëŒ€í™”";
        Conversation conversation = Conversation.builder()
            .user(user)
            .title(title)
            .build();
        Conversation saved = conversationRepository.save(conversation);
        return ConversationSummaryResponse.from(saved);
    }

    @Transactional
    public void deleteConversation(Long userId, Long conversationId) {
        Conversation conversation = findOwnedConversation(userId, conversationId);
        conversationRepository.delete(conversation);
    }

    Conversation findOwnedConversation(Long userId, Long conversationId) {
        return conversationRepository.findByIdAndUserId(conversationId, userId)
            .orElseThrow(() -> ApiException.notFound("ëŒ€í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    }
}
```

- **ì—­í• **: ëŒ€í™” ì¡°íšŒ/ìƒì„±/ì‚­ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `getConversations()`: ì‚¬ìš©ìì˜ ëŒ€í™” ëª©ë¡ ì¡°íšŒ (ìµœì‹ ìˆœ)
  - `getConversation()`: ëŒ€í™” ìƒì„¸ ì •ë³´ + ë©”ì‹œì§€ ëª©ë¡
  - `createConversation()`: ìƒˆ ëŒ€í™” ìƒì„± (ì œëª© ì—†ìœ¼ë©´ "ìƒˆ ëŒ€í™”")
  - `deleteConversation()`: ëŒ€í™” ì‚­ì œ (ì†Œìœ ê¶Œ ê²€ì¦)
  - `findOwnedConversation()`: ì†Œìœ ê¶Œ ê²€ì¦ ìœ í‹¸ë¦¬í‹°

---

### 7. message íŒ¨í‚¤ì§€ (ë©”ì‹œì§€ ë„ë©”ì¸)

#### SenderType.java

```java
public enum SenderType {
    USER,
    ASSISTANT,
    SYSTEM
}
```

- **ì—­í• **: ë©”ì‹œì§€ ë°œì‹ ì íƒ€ì… enum

#### Message.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "messages")
public class Message {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY, optional = false)
    @JoinColumn(name = "conversation_id")
    private Conversation conversation;

    @Enumerated(EnumType.STRING)
    @Column(name = "sender", nullable = false, length = 10)
    private SenderType sender;

    @Column(name = "text", nullable = false, columnDefinition = "text")
    private String text;

    @Column(name = "time_label", length = 20)
    private String timeLabel;

    @Column(name = "created_at", nullable = false)
    private OffsetDateTime createdAt;

    @PrePersist
    void onPersist() {
        this.createdAt = OffsetDateTime.now(ZoneOffset.UTC);
    }
}
```

- **ì—­í• **: ëŒ€í™” ì•ˆì˜ ê°œë³„ ë©”ì‹œì§€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì—”í‹°í‹°
- **ì£¼ìš” í•„ë“œ**:
  - `conversation`: ì†í•œ ëŒ€í™” (ManyToOne)
  - `sender`: ë°œì‹ ì íƒ€ì… (USER, ASSISTANT, SYSTEM)
  - `text`: ë©”ì‹œì§€ ë³¸ë¬¸
  - `timeLabel`: ì‹œê°„/íƒ€ì´ë° ë¼ë²¨
  - `createdAt`: ìƒì„± ì‹œê°„ (UTC, ìë™ ì„¤ì •)

#### MessageRepository.java

```java
public interface MessageRepository extends JpaRepository<Message, Long> {
    List<Message> findByConversationIdOrderByCreatedAtAsc(Long conversationId);
    long countByConversationId(Long conversationId);
    void deleteByConversationId(Long conversationId);
    Optional<Message> findByIdAndConversationId(Long id, Long conversationId);
}
```

- **ì—­í• **: Message ì—”í‹°í‹°ì˜ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼
- **ì£¼ìš” ì¿¼ë¦¬**:
  - `findByConversationIdOrderByCreatedAtAsc`: ëŒ€í™”ì˜ ë©”ì‹œì§€ ëª©ë¡ (ì‹œê°„ìˆœ)
  - `countByConversationId`: ëŒ€í™”ì˜ ë©”ì‹œì§€ ê°œìˆ˜
  - `deleteByConversationId`: ëŒ€í™”ì˜ ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ
  - `findByIdAndConversationId`: íŠ¹ì • ë©”ì‹œì§€ ì¡°íšŒ (ì†Œìœ ê¶Œ ê²€ì¦ìš©)

#### MessageService.java

```java
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class MessageService {
    private final ConversationRepository conversationRepository;
    private final MessageRepository messageRepository;

    @Transactional
    public MessageResponse addMessage(Long userId, Long conversationId, 
                                     MessageRequest request) {
        Conversation conversation = getOwnedConversation(userId, conversationId);
        boolean firstMessage = messageRepository.countByConversationId(conversationId) == 0;

        Message message = Message.builder()
            .conversation(conversation)
            .sender(request.getSender())
            .text(request.getText())
            .timeLabel(request.getTimeLabel())
            .build();

        Message saved = messageRepository.save(message);

        if (firstMessage) {
            conversation.renameWithSnippet(request.getText());
        } else {
            conversation.markUpdated();
        }

        return MessageResponse.from(saved);
    }

    @Transactional
    public void deleteMessage(Long userId, Long conversationId, Long messageId) {
        Conversation conversation = getOwnedConversation(userId, conversationId);
        Message message = messageRepository.findByIdAndConversationId(
                messageId, conversation.getId())
            .orElseThrow(() -> ApiException.notFound("ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        messageRepository.delete(message);
        conversation.markUpdated();
    }

    @Transactional
    public void clearMessages(Long userId, Long conversationId) {
        Conversation conversation = getOwnedConversation(userId, conversationId);
        messageRepository.deleteByConversationId(conversation.getId());
        conversation.markUpdated();
    }

    private Conversation getOwnedConversation(Long userId, Long conversationId) {
        return conversationRepository.findByIdAndUserId(conversationId, userId)
            .orElseThrow(() -> ApiException.notFound("ëŒ€í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    }
}
```

- **ì—­í• **: ë©”ì‹œì§€ ì¶”ê°€/ì‚­ì œ/ì „ì²´ ì‚­ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `addMessage()`: ë©”ì‹œì§€ ì¶”ê°€
    - ì²« ë©”ì‹œì§€ë©´ ëŒ€í™” ì œëª©ì„ ë©”ì‹œì§€ ì•ë¶€ë¶„ìœ¼ë¡œ ìë™ ì„¤ì •
    - ì´í›„ ë©”ì‹œì§€ëŠ” ëŒ€í™”ì˜ `updatedAt`ë§Œ ê°±ì‹ 
  - `deleteMessage()`: íŠ¹ì • ë©”ì‹œì§€ ì‚­ì œ
  - `clearMessages()`: ëŒ€í™”ì˜ ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ

---

### 8. analysis íŒ¨í‚¤ì§€ (ë¶„ì„ ì„œë¹„ìŠ¤)

#### AnalysisService.java

```java
@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class AnalysisService {
    private final ConversationRepository conversationRepository;
    private final MessageRepository messageRepository;

    @Transactional
    public AnalysisResponse analyze(Long userId, Long conversationId, 
                                   AnalysisRequest request) {
        Conversation conversation = conversationRepository.findByIdAndUserId(
                conversationId, userId)
            .orElseThrow(() -> ApiException.notFound("ëŒ€í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

        List<AnalysisMessageDto> source = resolveMessages(conversation.getId(), request);
        String summary = buildSummary(source);
        List<String> advice = buildAdvice(source);
        List<String> samples = buildSamples();

        conversation.applyAnalysis(summary, advice, samples);

        return AnalysisResponse.builder()
            .conversationId(conversation.getId())
            .summary(summary)
            .advice(advice)
            .sampleReplies(samples)
            .build();
    }

    private List<AnalysisMessageDto> resolveMessages(Long conversationId, 
                                                     AnalysisRequest request) {
        if (request != null && !CollectionUtils.isEmpty(request.getMessages())) {
            return request.getMessages();
        }
        return messageRepository.findByConversationIdOrderByCreatedAtAsc(conversationId)
            .stream()
            .map(message -> AnalysisMessageDto.builder()
                .sender(message.getSender())
                .text(message.getText())
                .timeLabel(message.getTimeLabel())
                .build())
            .toList();
    }

    private String buildSummary(List<AnalysisMessageDto> messages) {
        return messages.stream()
            .map(AnalysisMessageDto::getText)
            .filter(StringUtils::hasText)
            .limit(3)
            .reduce((a, b) -> a + " / " + b)
            .orElse("ìš”ì•½í•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
    }

    private List<String> buildAdvice(List<AnalysisMessageDto> messages) {
        List<String> advice = new ArrayList<>();
        advice.add("í•µì‹¬ ì§ˆë¬¸ì— ì§‘ì¤‘í•˜ì—¬ ëŒ€í™”ë¥¼ ì •ë¦¬í•˜ì„¸ìš”.");
        advice.add("ìƒëŒ€ë°©ì˜ ì‘ë‹µì—ì„œ ë¹ˆí‹ˆì„ ì°¾ì•„ í›„ì† ì§ˆë¬¸ì„ ì¤€ë¹„í•˜ì„¸ìš”.");
        boolean hasUserVoice = messages.stream()
            .anyMatch(m -> m.getSender() == SenderType.USER);
        if (hasUserVoice) {
            advice.add("ì‚¬ìš©ìì˜ ê°ì •ì„ ë°˜ì˜í•˜ëŠ” ê³µê° í‘œí˜„ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.");
        }
        return advice;
    }

    private List<String> buildSamples() {
        return List.of(
            "ë” êµ¬ì²´ì ì¸ ìƒí™©ì„ ì•Œë ¤ì£¼ì‹œë©´ ë„ì›€ì´ ë  ê²ƒ ê°™ì•„ìš”.",
            "ë§ì”€í•˜ì‹  ë‚´ìš©ì„ ê¸°ì¤€ìœ¼ë¡œ ë‘ ê°€ì§€ ë°©ì•ˆì„ ì œì•ˆë“œë¦´ê²Œìš”.",
            "í•„ìš”í•˜ì‹œë‹¤ë©´ ê´€ë ¨ ìë£Œë„ í•¨ê»˜ ì •ë¦¬í•´ë“œë¦´ ìˆ˜ ìˆì–´ìš”."
        );
    }
}
```

- **ì—­í• **: ëŒ€í™” ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ìš”ì•½, ì¡°ì–¸, ìƒ˜í”Œ ë‹µë³€ ìƒì„±
- **ì£¼ìš” ë©”ì„œë“œ**:
  - `analyze()`: ëŒ€í™” ë¶„ì„ ìˆ˜í–‰
    - ìš”ì²­ì— ë©”ì‹œì§€ ëª©ë¡ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ DBì—ì„œ ì¡°íšŒ
    - ìš”ì•½/ì¡°ì–¸/ìƒ˜í”Œ ìƒì„± í›„ `Conversation.applyAnalysis()`ë¡œ ì €ì¥
  - `buildSummary()`: ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ìƒìœ„ 3ê°œë¥¼ "/"ë¡œ ì—°ê²°í•˜ì—¬ ìš”ì•½
  - `buildAdvice()`: ê¸°ë³¸ ì¡°ì–¸ 2ê°œ + USER ë°œí™”ê°€ ìˆìœ¼ë©´ ê³µê° í‘œí˜„ ì¡°ì–¸ ì¶”ê°€
  - `buildSamples()`: ê³ ì •ëœ ìƒ˜í”Œ ë‹µë³€ 3ê°œ ë°˜í™˜

---

### 9. controller íŒ¨í‚¤ì§€ (REST API)

#### AuthController.java

```java
@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class AuthController {
    private final UserService userService;

    @GetMapping("/me")
    public ApiResponse<AuthUserResponse> me(
        @AuthenticationPrincipal UserPrincipal principal) {
        if (principal == null) {
            throw ApiException.unauthorized("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
        var user = userService.getUserOrThrow(principal.getId());
        return ApiResponse.ok(AuthUserResponse.from(user));
    }
}
```

- **ì—”ë“œí¬ì¸íŠ¸**: `GET /auth/me`
- **ê¸°ëŠ¥**: ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ

#### ConversationController.java

```java
@RestController
@RequestMapping("/conversations")
@RequiredArgsConstructor
@Validated
public class ConversationController {
    private final ConversationService conversationService;

    @GetMapping
    public ApiResponse<List<ConversationSummaryResponse>> list(
        @AuthenticationPrincipal UserPrincipal principal) {
        return ApiResponse.ok(conversationService.getConversations(principal.getId()));
    }

    @PostMapping
    public ApiResponse<ConversationSummaryResponse> create(
        @AuthenticationPrincipal UserPrincipal principal,
        @Valid @RequestBody ConversationCreateRequest request) {
        return ApiResponse.ok(
            conversationService.createConversation(principal.getId(), request));
    }

    @GetMapping("/{conversationId}")
    public ApiResponse<ConversationDetailResponse> detail(
        @AuthenticationPrincipal UserPrincipal principal,
        @PathVariable Long conversationId) {
        return ApiResponse.ok(
            conversationService.getConversation(principal.getId(), conversationId));
    }

    @DeleteMapping("/{conversationId}")
    public ResponseEntity<Void> delete(
        @AuthenticationPrincipal UserPrincipal principal,
        @PathVariable Long conversationId) {
        conversationService.deleteConversation(principal.getId(), conversationId);
        return ResponseEntity.noContent().build();
    }
}
```

- **ì—”ë“œí¬ì¸íŠ¸**:
  - `GET /conversations`: ëŒ€í™” ëª©ë¡ ì¡°íšŒ
  - `POST /conversations`: ìƒˆ ëŒ€í™” ìƒì„±
  - `GET /conversations/{id}`: ëŒ€í™” ìƒì„¸ ì¡°íšŒ
  - `DELETE /conversations/{id}`: ëŒ€í™” ì‚­ì œ

#### MessageController.java

```java
@RestController
@RequestMapping("/conversations/{conversationId}/messages")
@RequiredArgsConstructor
public class MessageController {
    private final MessageService messageService;

    @PostMapping
    public ApiResponse<MessageResponse> create(
        @AuthenticationPrincipal UserPrincipal principal,
        @PathVariable Long conversationId,
        @Valid @RequestBody MessageRequest request) {
        return ApiResponse.ok(
            messageService.addMessage(principal.getId(), conversationId, request));
    }

    @DeleteMapping("/{messageId}")
    public ResponseEntity<Void> delete(
        @AuthenticationPrincipal UserPrincipal principal,
        @PathVariable Long conversationId,
        @PathVariable Long messageId) {
        messageService.deleteMessage(principal.getId(), conversationId, messageId);
        return ResponseEntity.noContent().build();
    }

    @DeleteMapping
    public ResponseEntity<Void> clear(
        @AuthenticationPrincipal UserPrincipal principal,
        @PathVariable Long conversationId) {
        messageService.clearMessages(principal.getId(), conversationId);
        return ResponseEntity.noContent().build();
    }
}
```

- **ì—”ë“œí¬ì¸íŠ¸**:
  - `POST /conversations/{id}/messages`: ë©”ì‹œì§€ ì¶”ê°€
  - `DELETE /conversations/{id}/messages/{messageId}`: íŠ¹ì • ë©”ì‹œì§€ ì‚­ì œ
  - `DELETE /conversations/{id}/messages`: ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ

#### AnalysisController.java

```java
@RestController
@RequestMapping("/conversations/{conversationId}/analyze")
@RequiredArgsConstructor
public class AnalysisController {
    private final AnalysisService analysisService;

    @PostMapping
    public ApiResponse<AnalysisResponse> analyze(
        @AuthenticationPrincipal UserPrincipal principal,
        @PathVariable Long conversationId,
        @Valid @RequestBody(required = false) AnalysisRequest request) {
        return ApiResponse.ok(
            analysisService.analyze(principal.getId(), conversationId, request));
    }
}
```

- **ì—”ë“œí¬ì¸íŠ¸**: `POST /conversations/{id}/analyze`
- **ê¸°ëŠ¥**: ëŒ€í™” ë¶„ì„ ìˆ˜í–‰ (ìš”ì²­ì— ë©”ì‹œì§€ ëª©ë¡ì´ ì—†ìœ¼ë©´ DBì—ì„œ ì¡°íšŒ)

---

### 10. dto íŒ¨í‚¤ì§€ (ë°ì´í„° ì „ì†¡ ê°ì²´)

#### ApiResponse.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ApiResponse<T> {
    private boolean success;
    private T data;
    @Builder.Default
    private OffsetDateTime timestamp = OffsetDateTime.now(ZoneOffset.UTC);

    public static <T> ApiResponse<T> ok(T data) {
        return ApiResponse.<T>builder()
            .success(true)
            .data(data)
            .timestamp(OffsetDateTime.now(ZoneOffset.UTC))
            .build();
    }
}
```

- **ì—­í• **: ëª¨ë“  ì„±ê³µ ì‘ë‹µì˜ ê³µí†µ ë˜í¼
- **í•„ë“œ**: `success`, `data`, `timestamp`

#### ApiErrorResponse.java

```java
@Getter
@Builder
public class ApiErrorResponse {
    private final boolean success = false;
    private final String code;
    private final String message;
    private final OffsetDateTime timestamp;
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private final Map<String, String> errors;

    public static ApiErrorResponse of(HttpStatus status, String message, 
                                     Map<String, String> errors) {
        return ApiErrorResponse.builder()
            .code(status.name())
            .message(message)
            .errors(errors)
            .timestamp(OffsetDateTime.now(ZoneOffset.UTC))
            .build();
    }

    public static ApiErrorResponse unauthorized() {
        return of(HttpStatus.UNAUTHORIZED, "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.", null);
    }

    public static ApiErrorResponse forbidden() {
        return of(HttpStatus.FORBIDDEN, "ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.", null);
    }

    public String toJson() {
        try {
            return new ObjectMapper().writeValueAsString(this);
        } catch (Exception e) {
            return "{\"success\":false}";
        }
    }
}
```

- **ì—­í• **: ëª¨ë“  ì—ëŸ¬ ì‘ë‹µì˜ ê³µí†µ í¬ë§·
- **í•„ë“œ**: `success` (í•­ìƒ false), `code`, `message`, `timestamp`, `errors` (ì„ íƒ)

#### AuthUserResponse.java

```java
@Getter
@Builder
public class AuthUserResponse {
    private Long id;
    private String email;
    private String name;
    private String profileImage;
    private String plan;

    public static AuthUserResponse from(User user) {
        return AuthUserResponse.builder()
            .id(user.getId())
            .email(user.getEmail())
            .name(user.getName())
            .profileImage(user.getProfileImage())
            .plan(user.getPlan() != null ? user.getPlan().name() : null)
            .build();
    }
}
```

- **ì—­í• **: ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ DTO

#### JwtLoginResponse.java

```java
@Getter
@Builder
public class JwtLoginResponse {
    private String token;
    private long expiresIn;
    private Instant issuedAt;
    private AuthUserResponse user;
}
```

- **ì—­í• **: OAuth2 ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë°˜í™˜ë˜ëŠ” JWT ì •ë³´

#### ConversationCreateRequest.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ConversationCreateRequest {
    @Size(max = 100, message = "ì œëª©ì€ 100ìë¥¼ ë„˜ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    private String title;
}
```

- **ì—­í• **: ëŒ€í™” ìƒì„± ìš”ì²­ DTO
- **ìœ íš¨ì„± ê²€ì‚¬**: ì œëª© ìµœëŒ€ 100ì

#### ConversationSummaryResponse.java

```java
@Getter
@Builder
public class ConversationSummaryResponse {
    private Long id;
    private String title;
    private OffsetDateTime updatedAt;

    public static ConversationSummaryResponse from(Conversation conversation) {
        return ConversationSummaryResponse.builder()
            .id(conversation.getId())
            .title(conversation.getTitle())
            .updatedAt(conversation.getUpdatedAt())
            .build();
    }
}
```

- **ì—­í• **: ëŒ€í™” ëª©ë¡ ì¡°íšŒ ì‹œ ì‚¬ìš©í•˜ëŠ” ìš”ì•½ DTO

#### ConversationDetailResponse.java

```java
@Getter
@Builder
public class ConversationDetailResponse {
    private Long id;
    private String title;
    private OffsetDateTime updatedAt;
    private List<MessageResponse> messages;
    private ConversationAnalysisDto analysis;

    public static ConversationDetailResponse of(Conversation conversation,
                                               List<MessageResponse> messages) {
        return ConversationDetailResponse.builder()
            .id(conversation.getId())
            .title(conversation.getTitle())
            .updatedAt(conversation.getUpdatedAt())
            .messages(messages)
            .analysis(ConversationAnalysisDto.from(conversation))
            .build();
    }
}
```

- **ì—­í• **: ëŒ€í™” ìƒì„¸ ì¡°íšŒ ì‹œ ì‚¬ìš©í•˜ëŠ” DTO (ë©”ì‹œì§€ ëª©ë¡ + ë¶„ì„ ê²°ê³¼ í¬í•¨)

#### ConversationAnalysisDto.java

```java
@Getter
@Builder
public class ConversationAnalysisDto {
    private String summary;
    private List<String> advice;
    private List<String> sampleReplies;

    public static ConversationAnalysisDto from(Conversation conversation) {
        if (conversation.getAnalysisSummary() == null
            && conversation.getAnalysisAdvice() == null
            && conversation.getAnalysisSampleReplies() == null) {
            return null;
        }
        return ConversationAnalysisDto.builder()
            .summary(conversation.getAnalysisSummary())
            .advice(conversation.getAnalysisAdvice())
            .sampleReplies(conversation.getAnalysisSampleReplies())
            .build();
    }
}
```

- **ì—­í• **: ëŒ€í™” ë¶„ì„ ê²°ê³¼ë¥¼ ë‹´ëŠ” DTO
- **íŠ¹ì§•**: ë¶„ì„ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ `null` ë°˜í™˜

#### MessageRequest.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MessageRequest {
    @NotNull(message = "ë°œì‹ ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
    private SenderType sender;

    @NotBlank(message = "ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.")
    private String text;

    private String timeLabel;
}
```

- **ì—­í• **: ë©”ì‹œì§€ ìƒì„± ìš”ì²­ DTO
- **ìœ íš¨ì„± ê²€ì‚¬**: `sender` í•„ìˆ˜, `text` í•„ìˆ˜

#### MessageResponse.java

```java
@Getter
@Builder
public class MessageResponse {
    private Long id;
    private SenderType sender;
    private String text;
    private String timeLabel;
    private OffsetDateTime createdAt;

    public static MessageResponse from(Message message) {
        return MessageResponse.builder()
            .id(message.getId())
            .sender(message.getSender())
            .text(message.getText())
            .timeLabel(message.getTimeLabel())
            .createdAt(message.getCreatedAt())
            .build();
    }
}
```

- **ì—­í• **: ë©”ì‹œì§€ ì‘ë‹µ DTO

#### AnalysisRequest.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class AnalysisRequest {
    @Valid
    private List<AnalysisMessageDto> messages;
}
```

- **ì—­í• **: ëŒ€í™” ë¶„ì„ ìš”ì²­ DTO
- **íŠ¹ì§•**: `messages`ê°€ ë¹„ì–´ìˆê±°ë‚˜ `null`ì´ë©´ DBì—ì„œ ì¡°íšŒ

#### AnalysisMessageDto.java

```java
@Getter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class AnalysisMessageDto {
    @NotNull
    private SenderType sender;

    @NotBlank
    private String text;

    private String timeLabel;
}
```

- **ì—­í• **: ë¶„ì„ì— ì‚¬ìš©í•  ë©”ì‹œì§€ ì •ë³´ DTO

#### AnalysisResponse.java

```java
@Getter
@Builder
public class AnalysisResponse {
    private Long conversationId;
    private String summary;
    private List<String> advice;
    private List<String> sampleReplies;
}
```

- **ì—­í• **: ëŒ€í™” ë¶„ì„ ê²°ê³¼ ì‘ë‹µ DTO

---

### 11. exception íŒ¨í‚¤ì§€ (ì˜ˆì™¸ ì²˜ë¦¬)

#### ApiException.java

```java
@Getter
public class ApiException extends RuntimeException {
    private final HttpStatus status;

    private ApiException(HttpStatus status, String message) {
        super(message);
        this.status = status;
    }

    public static ApiException of(HttpStatus status, String message) {
        return new ApiException(status, message);
    }

    public static ApiException notFound(String message) {
        return of(HttpStatus.NOT_FOUND, message);
    }

    public static ApiException unauthorized(String message) {
        return of(HttpStatus.UNAUTHORIZED, message);
    }
}
```

- **ì—­í• **: HTTP ìƒíƒœ ì½”ë“œë¥¼ í¬í•¨í•˜ëŠ” ì»¤ìŠ¤í…€ ì˜ˆì™¸
- **ì£¼ìš” ë©”ì„œë“œ**: `notFound()`, `unauthorized()`

#### GlobalExceptionHandler.java

```java
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(ApiException.class)
    public ResponseEntity<ApiErrorResponse> handleApiException(ApiException ex) {
        log.warn("API ì˜ˆì™¸: {}", ex.getMessage());
        return ResponseEntity.status(ex.getStatus())
            .body(ApiErrorResponse.of(ex.getStatus(), ex.getMessage(), null));
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiErrorResponse> handleValidationException(
        MethodArgumentNotValidException ex) {
        Map<String, String> errors = ex.getBindingResult().getFieldErrors().stream()
            .collect(Collectors.toMap(
                fieldError -> fieldError.getField(),
                fieldError -> fieldError.getDefaultMessage(),
                (a, b) -> b
            ));
        return ResponseEntity.badRequest()
            .body(ApiErrorResponse.of(HttpStatus.BAD_REQUEST, "ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨", errors));
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiErrorResponse> handleUnexpected(Exception ex) {
        log.error("ì„œë²„ ì˜¤ë¥˜", ex);
        return ResponseEntity.internalServerError()
            .body(ApiErrorResponse.of(
                HttpStatus.INTERNAL_SERVER_ERROR, "ì„œë²„ ì˜¤ë¥˜", null));
    }
}
```

- **ì—­í• **: ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬
- **ì²˜ë¦¬ ëŒ€ìƒ**:
  - `ApiException`: ì»¤ìŠ¤í…€ ì˜ˆì™¸ â†’ HTTP ìƒíƒœ ì½”ë“œì— ë§ëŠ” ì—ëŸ¬ ì‘ë‹µ
  - `MethodArgumentNotValidException`: ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ â†’ 400 Bad Request
  - `Exception`: ì˜ˆìƒì¹˜ ëª»í•œ ì˜ˆì™¸ â†’ 500 Internal Server Error

---

## API ì—”ë“œí¬ì¸íŠ¸ ì •ë¦¬

### ì¸ì¦ ê´€ë ¨

| ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… | ì¸ì¦ í•„ìš” |
|--------|-----------|------|----------|
| GET | `/auth/me` | í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ | âœ… |
| GET | `/auth/google/**` | Google OAuth2 ë¡œê·¸ì¸ | âŒ |
| GET | `/oauth2/**` | OAuth2 ì½œë°± | âŒ |
| GET | `/login/**` | ë¡œê·¸ì¸ í˜ì´ì§€ | âŒ |

### ëŒ€í™” ê´€ë ¨

| ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… | ì¸ì¦ í•„ìš” |
|--------|-----------|------|----------|
| GET | `/conversations` | ëŒ€í™” ëª©ë¡ ì¡°íšŒ | âœ… |
| POST | `/conversations` | ìƒˆ ëŒ€í™” ìƒì„± | âœ… |
| GET | `/conversations/{id}` | ëŒ€í™” ìƒì„¸ ì¡°íšŒ | âœ… |
| DELETE | `/conversations/{id}` | ëŒ€í™” ì‚­ì œ | âœ… |

### ë©”ì‹œì§€ ê´€ë ¨

| ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… | ì¸ì¦ í•„ìš” |
|--------|-----------|------|----------|
| POST | `/conversations/{id}/messages` | ë©”ì‹œì§€ ì¶”ê°€ | âœ… |
| DELETE | `/conversations/{id}/messages/{messageId}` | íŠ¹ì • ë©”ì‹œì§€ ì‚­ì œ | âœ… |
| DELETE | `/conversations/{id}/messages` | ëª¨ë“  ë©”ì‹œì§€ ì‚­ì œ | âœ… |

### ë¶„ì„ ê´€ë ¨

| ë©”ì„œë“œ | ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… | ì¸ì¦ í•„ìš” |
|--------|-----------|------|----------|
| POST | `/conversations/{id}/analyze` | ëŒ€í™” ë¶„ì„ ìˆ˜í–‰ | âœ… |

---

## ì¸ì¦ & ì¸ê°€ íë¦„

### 1. Google OAuth2 ë¡œê·¸ì¸ íë¦„

```
[í´ë¼ì´ì–¸íŠ¸]                    [ë°±ì—”ë“œ]                    [Google]
     |                             |                          |
     |-- GET /auth/google -------->|                          |
     |                             |-- ë¦¬ë‹¤ì´ë ‰íŠ¸ ------------>|
     |                             |                          |
     |                             |<-- OAuth ì¸ì¦ ì„±ê³µ ------|
     |<-- ì½œë°±(/oauth2/code/google)-|                          |
     |                             |                          |
     |                             | [OAuth2SuccessHandler]    |
     |                             | 1. ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ       |
     |                             | 2. UserService.upsertGoogleUser() |
     |                             | 3. JWT í† í° ìƒì„±          |
     |<-- JWT í† í° ë˜ëŠ” ë¦¬ë‹¤ì´ë ‰íŠ¸ -|                          |
```

### 2. JWT ê¸°ë°˜ API ìš”ì²­ íë¦„

```
[í´ë¼ì´ì–¸íŠ¸]                    [ë°±ì—”ë“œ]
     |                             |
     |-- ìš”ì²­ + Authorization: Bearer {token} -->|
     |                             |                          |
     |                             | [JwtAuthenticationFilter] |
     |                             | 1. í† í° ì¶”ì¶œ             |
     |                             | 2. í† í° ê²€ì¦             |
     |                             | 3. UserPrincipal ìƒì„±    |
     |                             | 4. SecurityContext ì„¤ì •  |
     |                             |                          |
     |                             | [Controller]             |
     |                             | @AuthenticationPrincipal |
     |<-- ì‘ë‹µ --------------------|                          |
```

### 3. ì¸ì¦ ì‹¤íŒ¨ ì²˜ë¦¬

- **ì¸ì¦ ì‹¤íŒ¨ (401 Unauthorized)**: `RestAuthenticationEntryPoint`
  - JWT í† í°ì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°
- **ì¸ê°€ ì‹¤íŒ¨ (403 Forbidden)**: `JwtAccessDeniedHandler`
  - ì¸ì¦ì€ ë˜ì—ˆì§€ë§Œ ê¶Œí•œì´ ì—†ëŠ” ê²½ìš°

---

## ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

### ì—”í‹°í‹° ê´€ê³„ë„

```
User (ì‚¬ìš©ì)
  â”œâ”€â”€ id (PK)
  â”œâ”€â”€ provider (OAuth ì œê³µì)
  â”œâ”€â”€ provider_user_id (ì œê³µì ì‚¬ìš©ì ID)
  â”œâ”€â”€ email
  â”œâ”€â”€ name
  â”œâ”€â”€ profile_image
  â”œâ”€â”€ plan (FREE/PRO)
  â”œâ”€â”€ last_login_at
  â”œâ”€â”€ created_at
  â”œâ”€â”€ updated_at
  â””â”€â”€ conversations (OneToMany)
      â”‚
      â””â”€â”€ Conversation (ëŒ€í™”)
          â”œâ”€â”€ id (PK)
          â”œâ”€â”€ user_id (FK -> User.id)
          â”œâ”€â”€ title
          â”œâ”€â”€ analysis_summary (TEXT)
          â”œâ”€â”€ analysis_advice (JSONB)
          â”œâ”€â”€ analysis_sample_replies (JSONB)
          â”œâ”€â”€ created_at
          â”œâ”€â”€ updated_at
          â””â”€â”€ messages (OneToMany)
              â”‚
              â””â”€â”€ Message (ë©”ì‹œì§€)
                  â”œâ”€â”€ id (PK)
                  â”œâ”€â”€ conversation_id (FK -> Conversation.id)
                  â”œâ”€â”€ sender (USER/ASSISTANT/SYSTEM)
                  â”œâ”€â”€ text (TEXT)
                  â”œâ”€â”€ time_label
                  â””â”€â”€ created_at
```

### ì£¼ìš” í…Œì´ë¸”

#### users
- `id`: BIGINT (PK, AUTO_INCREMENT)
- `provider`: VARCHAR(20) (NOT NULL)
- `provider_user_id`: VARCHAR(255) (NOT NULL)
- `email`: VARCHAR(255) (NOT NULL, UNIQUE)
- `name`: VARCHAR(100)
- `profile_image`: TEXT
- `plan`: VARCHAR(20) (ê¸°ë³¸ê°’: 'FREE')
- `last_login_at`: TIMESTAMP WITH TIME ZONE
- `created_at`: TIMESTAMP WITH TIME ZONE (NOT NULL)
- `updated_at`: TIMESTAMP WITH TIME ZONE (NOT NULL)

#### conversations
- `id`: BIGINT (PK, AUTO_INCREMENT)
- `user_id`: BIGINT (FK -> users.id, NOT NULL)
- `title`: VARCHAR(100) (NOT NULL)
- `analysis_summary`: TEXT
- `analysis_advice`: JSONB (List<String>)
- `analysis_sample_replies`: JSONB (List<String>)
- `created_at`: TIMESTAMP WITH TIME ZONE (NOT NULL)
- `updated_at`: TIMESTAMP WITH TIME ZONE (NOT NULL)

#### messages
- `id`: BIGINT (PK, AUTO_INCREMENT)
- `conversation_id`: BIGINT (FK -> conversations.id, NOT NULL)
- `sender`: VARCHAR(10) (NOT NULL, USER/ASSISTANT/SYSTEM)
- `text`: TEXT (NOT NULL)
- `time_label`: VARCHAR(20)
- `created_at`: TIMESTAMP WITH TIME ZONE (NOT NULL)

---

## ì£¼ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìš”ì•½

### 1. ëŒ€í™” ìƒì„±
- ì‚¬ìš©ìê°€ ìƒˆ ëŒ€í™”ë¥¼ ìƒì„±í•˜ë©´ ê¸°ë³¸ ì œëª©ì€ "ìƒˆ ëŒ€í™”"
- ì²« ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ë©´ ëŒ€í™” ì œëª©ì´ ì²« ë©”ì‹œì§€ì˜ ì•ë¶€ë¶„(ìµœëŒ€ 50ì)ìœ¼ë¡œ ìë™ ë³€ê²½

### 2. ë©”ì‹œì§€ ì¶”ê°€
- ì²« ë©”ì‹œì§€ì¸ ê²½ìš°: ëŒ€í™” ì œëª© ìë™ ì„¤ì • (`renameWithSnippet`)
- ì´í›„ ë©”ì‹œì§€ì¸ ê²½ìš°: ëŒ€í™”ì˜ `updatedAt`ë§Œ ê°±ì‹  (`markUpdated`)

### 3. ëŒ€í™” ë¶„ì„
- ìš”ì²­ì— ë©”ì‹œì§€ ëª©ë¡ì´ ìˆìœ¼ë©´ í•´ë‹¹ ë©”ì‹œì§€ ì‚¬ìš©
- ì—†ìœ¼ë©´ DBì—ì„œ í•´ë‹¹ ëŒ€í™”ì˜ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì¡°íšŒ
- ë¶„ì„ ê²°ê³¼(ìš”ì•½, ì¡°ì–¸, ìƒ˜í”Œ ë‹µë³€)ëŠ” `Conversation` ì—”í‹°í‹°ì— ì €ì¥

### 4. ì†Œìœ ê¶Œ ê²€ì¦
- ëª¨ë“  ëŒ€í™”/ë©”ì‹œì§€ ê´€ë ¨ ì‘ì—…ì€ ì‚¬ìš©ì ì†Œìœ ê¶Œ ê²€ì¦ ìˆ˜í–‰
- `findByIdAndUserId` ë˜ëŠ” `findByIdAndConversationId`ë¡œ ê²€ì¦

---

## ì°¸ê³ ì‚¬í•­

### í™˜ê²½ ë³€ìˆ˜
- `OAUTH_GOOGLE_CLIENT_ID`: Google OAuth í´ë¼ì´ì–¸íŠ¸ ID
- `OAUTH_GOOGLE_CLIENT_SECRET`: Google OAuth í´ë¼ì´ì–¸íŠ¸ Secret
- `JWT_SECRET`: JWT ì„œëª… ì‹œí¬ë¦¿ í‚¤ (ê¸°ë³¸ê°’ ìˆìŒ)

### CORS ì„¤ì •
- í˜„ì¬ `http://localhost:3000`ë§Œ í—ˆìš©
- ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì‹¤ì œ í”„ë¡ íŠ¸ì—”ë“œ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½ í•„ìš”

### ë°ì´í„°ë² ì´ìŠ¤
- PostgreSQL ì‚¬ìš©
- JPA `ddl-auto: update`ë¡œ ìŠ¤í‚¤ë§ˆ ìë™ ìƒì„±
- UTC ì‹œê°„ëŒ€ ì‚¬ìš©

### ë¡œê¹…
- `com.smoothTalkAI.backend`: DEBUG ë ˆë²¨
- `org.springframework.security`: INFO ë ˆë²¨

---

**ë¬¸ì„œ ì‘ì„±ì¼**: 2024ë…„
**í”„ë¡œì íŠ¸**: SmoothTalkAI Backend
**Spring Boot ë²„ì „**: (build.gradle í™•ì¸ í•„ìš”)

